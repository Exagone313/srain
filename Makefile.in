# Makefile
.PHONY: install run bt clean cleanobj todo install-bin install-po install-data \
		install-doc view-doc doc bt gtk-dbg

# Export all variables
export

# Package meta message
PACKAGE = srain
PACKAGE_NAME = Srain
PACKAGE_APPID = im.srain.Srain
PACKAGE_BUILD = $(shell [ -d .git ] && \
				git rev-parse --git-dir > /dev/null 2>&1 && \
				echo -n -git@0.`git rev-list --count HEAD`.`git describe --always`)
PACKAGE_VERSION = 1.0.0rc1
PACKAGE_AUTHOR = Shengyu Zhang
PACKAGE_EMAIL = i@silverrainz.me
PACKAGE_DESC = Modern, beautiful IRC client written in GTK+ 3.
PACKAGE_WEBSITE = https://srain.im
PACKAGE_COPYRIGHT_DATES = 2016 - 2018
PACKAGE_DATA_DIR = $(DATADIR)
PACKAGE_CONFIG_DIR = $(SYSCONFDIR)

MAKE = make
DEL = rm -rf
INSTALL = install -v
DBG = gdb

BUILD_DIR = $(BUILDDIR)
TARGET = $(BUILD_DIR)/$(PACKAGE).out
FAKE_HOME = $(BUILD_DIR)/home/$(PACKAGE)
FAKE_XDG_DATA_DIR = $(PREFIX)/share:/usr/share:/usr/local/share

default: src/Makefile
	- mkdir -p $(BUILD_DIR)
	$(MAKE) -C data resources
	$(MAKE) -C src

install: install-bin install-data install-po

install-bin:
	$(INSTALL) -Dm755 "$(TARGET)" "$(DESTDIR)$(PREFIX)/bin/$(PACKAGE)"

install-data: data/Makefile
	$(MAKE) -C data

install-po: po/Makefile
	$(MAKE) -C po

install-doc: doc/Makefile
	$(MAKE) -C doc install

doc: doc/Makefile
	$(MAKE) -C doc

view-doc: doc/Makefile
	$(MAKE) -C doc view

run:
	unset XDG_CONFIG_HOME XDG_DATA_HOME XDG_CACHE_HOME; \
	export HOME=$(FAKE_HOME); \
	export XDG_DATA_DIRS=$(FAKE_XDG_DATA_DIR); \
	"$(DESTDIR)$(PREFIX)/bin/$(PACKAGE)"

bt:
	unset XDG_CONFIG_HOME XDG_DATA_HOME XDG_CACHE_HOME; \
	export HOME=$(FAKE_HOME); \
	export XDG_DATA_DIRS=$(FAKE_XDG_DATA_DIR); \
	$(DBG) "$(DESTDIR)$(PREFIX)/bin/$(PACKAGE)" -ex 'r' -ex 'bt' -ex 'q'

gtk-dbg:
	GTK_DEBUG=interactive \
	GOBJECT_DEBUG=instance-countcd \
	$(MAKE) run

clean:
	$(DEL) $(BUILD_DIR)/*

cleanobj:
	$(DEL) $(BUILD_DIR)/*.c
	$(DEL) $(BUILD_DIR)/*.o
	$(DEL) $(TARGET)

todo:
	grep --color=auto -r -E "TODO|FIXME" src/
